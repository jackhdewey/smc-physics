# smc-physics
Inferring latent physical properties of soft bodies from trajectory observations, using a generative model of rigid body dynamics and Sequential Monte Carlo inference (particle filtering) with MCMC rejuvenation.

# Use

First, place any 'ground truth' (synthetic) data you wish to use to perform inference in the "Data" folder.  

There are two subfolders currently located in the "Data" folder, one for data generated using RealFlow, and another for data generated using Bullet (more specifically, PyBullet).

To test the modeling / inference pipeline on a new dataset, simply add a new sub-subfolder with the name of that 'experiment' to one of these subfolders, or you can add an entirely new folder for example if you want to test on synthetic data generated using some different simulator.

To run inference on a particular dataset, you will work from "args.jl".  This is a struct containing a set of global parameters to modeling and inference.  For most users this one code file is all you need to run experiments. 

First, you will want to set expt_id to a string indicating the folder you want to pull your 'ground truth' data from.  Currently this can be either "BulletTest_[Sphere, Cube]", or "Expt[1, 2, 3, 4]".  If you wish to extend these naming conventions, you will have to modify a statement in main.jl that parses this string to the appropriate directory path.

Next are a pair of string parameters referring to the generative model.  The current iteration of the model is "Modelv5".  If an engineer makes substantial changes to the structure of the model, you will likely want to update this to 'v6', etc.  Otherwise, leave this parameter unchanged.  Next is a parameter that allows you to specify whether the generative model should represent the physical object as a "Sphere" or a "Cube".  These are the only two options currently supported.  If an engineer wants to add more shapes, they can modify the "init_target_state" function in "bouncing_object.jl" to support parsing into other PyBullet-supported shapes.

Next are a set of three floating point numbers referring to the noise parameters used in the generative model.  Each refers to the amount of statistical randomness, modeled as the standard deviation of a Gaussian, within a different component of the dynamics model it uses to represent the physical world.  "init_vel_noise" refers to its uncertainty about the initial velocity of the object.  "observation noise" refers to its uncertainty about the accuracy of its observation of the position of the object.  "transition_noise" refers to its uncertainty about how far and in what direction the object travels at each time step.

The next block of parameters modifies the inference algorithm used to estimate unobserved 'latent' parameters.  First is a string which specifies the class of algorithm used.  Currently the supported options are "SMC" and "MCMC".  The remaining three parameters are used only during Sequential Monte Carlo inference, and so can be ignored / left to whatever value you want if you choose to run MCMC.  These parameters are "num_particles", which is the number of parallel simulations (i.e. the size of the hypothesis space) used during inference.  "rejuvenation_moves" refers to the number of times (at each timestep) that the model 'thinks back to the beginning', perturbing its estimate of the ground truth elasticity and rerunning that particle (simulation) from the beginning with the new elasticity. Upon doing so, a check is performed whether to 'accept' the change to the particle, updating its elasticity and trajectory estimate p to that timestep. Finally, "save_particles" is a boolean indicating whether you want to record and save the intermediate state of the particle filter at each time step, rather than simply returning the final set of particles. Note that this typically produces quite a large number of files.

All files outputted by the pipeline are automatically stored in autogenereted subdirectories within the "Analysis" folder.  These are organized first by the experiment, then the model, then the model parameters, then the inference algorithm, then the inference parameters.  At each of these locations you will find folders for "Data" and "Plots". The Data folder is typically holding two additional folders, one for "Inferences" and one for "Intermediate".  Inferences holds the final state of the particle filter or the output of MCMC, while "Intermediate" holds all the intermediate states of the particle filter (if you chose to save them). 

Once you have generated this data, you now know where to access it.  Typically you will want to parse this data into a easier to understand visual form and perform some analysis.  There is a file located in the analysis folder called "analysis.jl" - this file is still under the final stages of construction, but it is designed to generate three types of plots.  The first kind of plot simply plots the output elasticity estimate of the model against either the ground truth elasticity or the human judgment.  The second kind of plot requires the intermediate states of the particle filter, and plots / overlays those trajectories in a series of '3D' showing the evolution of the particle filter in terms of the trajectories through space, relative to the ground truth trajectory.  Finally, there is a violin plot which also requires the intermediate states of the particle filter, and shows how the estimates of elasticity evolve over time, relative to the ground truth and human-inferred elasticity estimates.


# For an Engineer

This codebase is largely functional and complete, with some of the limitations mentioned above requiring minimal interventions to the code should you wish to extend the range of experiments you can run.

I suspect those interested in carrying forward this project will find that they may wish to make changes over time to the generative model and/or inference algorithm(s).  The correct files for doing so are "bouncing_object.jl" and "particle_filter.jl".  Of course, if you want to model an entirely different domain, it will probably be advisable to create a new julia file in the "Model" folder for that new model.  Otherwise, you may want to add / remove noise from some component or other of the current generative model.  For inference, you are free to make changes, for example, to the proposal function used during rejuvenation that suggest changes to the previous elasticity estimate.  There is a whole space of inference techniques you may want to test - again, if you move beyond the basic particle filtering, you may want to simply create a new julia file in the "Inference" folder. All of this is up to your discretion.  